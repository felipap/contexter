services:
  app:
    build: .
    restart: unless-stopped
    ports:
      - "3030:3000"
    environment:
      DATABASE_URL: file:/app/data/vaulty.db
      DASHBOARD_SECRET: ${DASHBOARD_SECRET}
      API_WRITE_SECRET: ${API_WRITE_SECRET}
      CRON_SECRET: ${CRON_SECRET}
      WEBSITE_HOST: ${WEBSITE_HOST:-}
      DASHBOARD_IP_WHITELIST: ${DASHBOARD_IP_WHITELIST:-}
      API_WRITE_IP_WHITELIST: ${API_WRITE_IP_WHITELIST:-}
      API_READ_IP_WHITELIST: ${API_READ_IP_WHITELIST:-}
      SCREENSHOT_RETENTION_HOURS: ${SCREENSHOT_RETENTION_HOURS:-1}
      IMESSAGE_RETENTION_HOURS: ${IMESSAGE_RETENTION_HOURS:-0}
      WHATSAPP_RETENTION_HOURS: ${WHATSAPP_RETENTION_HOURS:-0}
      CONTACT_RETENTION_HOURS: ${CONTACT_RETENTION_HOURS:-0}
      LOCATION_RETENTION_HOURS: ${LOCATION_RETENTION_HOURS:-0}
      STICKIES_RETENTION_HOURS: ${STICKIES_RETENTION_HOURS:-0}
      LOG_RETENTION_HOURS: ${LOG_RETENTION_HOURS:-0}
    volumes:
      - dbdata:/app/data

  cron:
    image: alpine:3
    restart: unless-stopped
    depends_on:
      - app
    environment:
      CRON_SECRET: ${CRON_SECRET}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl
        echo "*/5 * * * * curl -sf -H 'Authorization: Bearer '\"$$CRON_SECRET\" http://app:3000/api/cron/cleanup" | crontab -
        crond -f -l 2

volumes:
  dbdata:
